<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>小吳組 表藝課 入場系統</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body {
      font-family: "Arial", sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }
    .container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }
    .panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 300px;
    }
    .video-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #video-container {
      width: 640px;
      height: 480px;
      margin-bottom: 20px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: fill;
    }
    ul {
      padding-left: 20px;
      list-style-type: none;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }
    li {
      margin: 4px 0;
    }
    input[type="text"] {
      padding: 8px;
      font-size: 16px;
      width: 80%;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 8px 14px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
    select {
      padding: 8px;
      font-size: 16px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
    }
    #scan-result {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
      min-height: 30px;
    }
    @media (max-width: 600px) {
      .panel {
        padding: 15px;
      }
      input[type="text"] {
        width: 70%;
      }
      button {
        width: 100%;
        margin-top: 8px;
      }
      .container {
        flex-direction: column;
        gap: 10px;
      }
      #video-container {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- 攝影機掃描 -->
    <div class="panel">
      <h2>🎥 攝影機掃描</h2>
      <div class="video-container">
        <div id="video-container">
          <video autoplay playsinline muted></video>
        </div>
      </div>
      <div class="result" id="scan-result">攝影機初始化中...</div>
      <button id="start-audio" onclick="toggleAudio()">🔇 禁用朗讀中</button>
    </div>

    <!-- 手動與統計 -->
    <div class="panel">
      <h2>⌨️ 手動輸入票號</h2>
      <input type="text" id="manual-code" placeholder="輸入票號如 tcjhs113XXXXX" />
      <button onclick="manualEntry()">送出</button>

      <h2>📊 入場統計資訊</h2>
      <div class="stats">
        <div>總發行：<span id="total-count"></span></div>
        <div>已入場：<span id="entered-count">0</span></div>
        <div>未入場：<span id="remaining-count">0</span></div>
      </div>

      <h2>📋 入場名單</h2>
      <ul id="entry-list"></ul>

      <button onclick="downloadTXT()">下載入場紀錄</button>
      <button onclick="resetEntries()">🔄 重置入場紀錄</button>
    </div>
  </div>

  <script>
    const issuedTickets = `
tcjhs11372100
tcjhs11372101
tcjhs11372102
tcjhs11372103
tcjhs11372104
tcjhs11372105
tcjhs11372106
tcjhs11372107
tcjhs11372108
tcjhs11372109
tcjhs11372110
tcjhs11372111
tcjhs11372112
tcjhs11372113
tcjhs11372115
tcjhs11372116
tcjhs11372117
tcjhs11372118
tcjhs11372131
tcjhs11372132
tcjhs11372133
tcjhs11372134
tcjhs11372135
tcjhs11372137
tcjhs11372138
tcjhs11372139
tcjhs11372140
tcjhs11372141
tcjhs11372142
tcjhs11372143
tcjhs11372144
tcjhs11372145
tcjhs11372146`.trim().split('\n').map(s => s.trim().toLowerCase());

    const customMessages = {
      'tcjhs11372100': '歡迎 男神老師 入場！',
      'tcjhs11372102': '恭迎 執行長 王顗翔 入場！',
      'tcjhs11372103': '有請 製作人 小吳 入場！',
      'tcjhs11372112': '歡迎 前台經理 紹均 入場！',
      'tcjhs11372143': '歡迎 總導演 溫宜芳 入場！'
    };

        const enteredTickets = new Set();
    const result = document.getElementById('scan-result');
    const totalCount = document.getElementById('total-count');
    const enteredCount = document.getElementById('entered-count');
    const remainingCount = document.getElementById('remaining-count');
    const entryList = document.getElementById('entry-list');
    totalCount.textContent = issuedTickets.length;

    let audioEnabled = false;
    let isSpeaking = false; // 標記是否正在朗讀

    function updateStats() {
      enteredCount.textContent = enteredTickets.size;
      remainingCount.textContent = issuedTickets.length - enteredTickets.size;
    }
      
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-TW';
      utterance.rate = 1;
      utterance.pitch = 1;
      utterance.onstart = function() {
        isSpeaking = true; // 標記為正在朗讀
      };
      utterance.onend = function() {
        isSpeaking = false; // 朗讀完成，標記為未朗讀
      };
      speechSynthesis.speak(utterance);
    }
  
    function showTemporaryMessage(message, color = 'green') {
      result.textContent = message;
      result.style.color = color;

      clearTimeout(showTemporaryMessage.timeoutId);
      showTemporaryMessage.timeoutId = setTimeout(() => {
        result.textContent = '請掃描票券或輸入票號';
        result.style.color = 'black';
      }, 5000);
    }

    function convertToChinese(number) {
      const chineseNumbers = ['零', '一', '二', '三', '四', '五', '六', '七', '八', '九'];
      return number.toString().split('').map(digit => {
        const n = parseInt(digit);
        return (isNaN(n) ? '' : chineseNumbers[n]);
      }).join('');
    }

    function handleCode(code) {
      if (isSpeaking) {
        result.textContent = "⏳ 請等朗讀完成後再掃描";
        result.style.color = 'red';
        return;
      }

      code = code.trim().toLowerCase();
      if (!issuedTickets.includes(code)) {
        showTemporaryMessage('❌ 非法票券或無效代碼', 'red');
        return;
      }
      if (enteredTickets.has(code)) {
        showTemporaryMessage('⚠️ 票券已入場', 'orange');
        return;
      }

      enteredTickets.add(code);
      updateStats();

      const customMsg = customMessages[code];
      let speakText = '';

      if (customMsg) {
        speakText = customMsg;
        showTemporaryMessage(customMsg, 'blue');
      } else {
        // 轉換票號末五碼為中文數字
        const lastFive = code.slice(-5);
        const chineseNum = convertToChinese(lastFive);
        speakText = `歡迎 ${chineseNum} 號貴賓入場！`;
        showTemporaryMessage(speakText, 'green');
      }
      speak(speakText);

      // 更新入場列表
      const li = document.createElement('li');
      li.textContent = code;
      entryList.appendChild(li);
    }

    function manualEntry() {
      const input = document.getElementById('manual-code');
      const code = input.value.trim();
      if (code === '') {
        alert('請輸入票號');
        return;
      }
      handleCode(code);
      input.value = '';
      input.focus();
    }

    function resetEntries() {
      if (!confirm('確定要重置所有入場紀錄嗎？')) return;

      enteredTickets.clear();
      updateStats();
      entryList.innerHTML = '';
      showTemporaryMessage('已重置入場紀錄', 'black');
    }

    function downloadTXT() {
      if (enteredTickets.size === 0) {
        alert('目前無入場紀錄可下載');
        return;
      }
      const content = Array.from(enteredTickets).join('\n');
      const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = '入場紀錄.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function toggleAudio() {
      audioEnabled = !audioEnabled;
      const btn = document.getElementById('start-audio');
      if (audioEnabled) {
        btn.textContent = '🔊 朗讀已啟用';
        btn.style.backgroundColor = '#28a745';
      } else {
        btn.textContent = '🔇 朗讀已禁用';
        btn.style.backgroundColor = '#6c757d';
        speechSynthesis.cancel();
        isSpeaking = false;
      }
    }

    // Quagga 初始化
    function startScanner() {
      if (!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia !== 'function') {
        result.textContent = "📵 您的瀏覽器不支援攝影機掃描";
        return;
      }

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#video-container'),
          constraints: {
            facingMode: "environment",
            width: { min: 640 },
            height: { min: 480 }
          }
        },
        decoder: {
          readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
        },
        locate: true,
        numOfWorkers: navigator.hardwareConcurrency || 4,
        frequency: 10
      }, function(err) {
        if (err) {
          console.error(err);
          result.textContent = "🚫 攝影機啟動失敗";
          return;
        }
        Quagga.start();
        result.textContent = "📡 請掃描票券條碼";
        result.style.color = 'black';
      });

      Quagga.onDetected(data => {
        if (!data || !data.codeResult || !data.codeResult.code) return;
        const code = data.codeResult.code;
        // 因條碼可能有大小寫及前後空白，這邊強制小寫並trim
        handleCode(code.toLowerCase().trim());
      });
    }

    // 初始化
    window.onload = () => {
      result.textContent = '請掃描票券或輸入票號';
      updateStats();
      startScanner();
    };
  </script>
</body>
</html>
