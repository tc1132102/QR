<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°å³çµ„ è¡¨è—èª² å…¥å ´ç³»çµ±</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body {
      font-family: "Arial", sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }

    .container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      flex-wrap: wrap;
    }

    .panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 300px;
    }

    .video-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #video-container {
      width: 640px;
      height: 480px;
      margin-bottom: 20px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: fill;
    }

    ul {
      padding-left: 20px;
      list-style-type: none;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fafafa;
    }

    li {
      margin: 4px 0;
      font-weight: 500;
    }

    input[type="text"] {
      padding: 8px;
      font-size: 16px;
      width: 80%;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 8px 14px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #0056b3;
    }

    select {
      padding: 8px;
      font-size: 16px;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-size: 18px;
    }

    #scan-result {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
      min-height: 40px;
    }

    @media (max-width: 600px) {
      .panel {
        padding: 15px;
      }
      input[type="text"] {
        width: 70%;
      }
      button {
        width: 100%;
        margin-top: 10px;
      }
      .container {
        flex-direction: column;
        gap: 10px;
      }
      #video-container {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- æ”å½±æ©Ÿæƒæ -->
    <div class="panel">
      <h2>ğŸ¥ æ”å½±æ©Ÿæƒæ</h2>
      <div class="video-container">
        <div id="video-container">
          <video autoplay playsinline muted></video>
        </div>
      </div>
      <div class="result" id="scan-result">æ”å½±æ©Ÿåˆå§‹åŒ–ä¸­...</div>
      <button id="start-audio" onclick="toggleAudio()">ğŸ”‡ ç¦ç”¨æœ—è®€ä¸­</button>
    </div>

    <!-- æ‰‹å‹•èˆ‡çµ±è¨ˆ -->
    <div class="panel">
      <h2>âŒ¨ï¸ æ‰‹å‹•è¼¸å…¥ç¥¨è™Ÿ</h2>
      <input type="text" id="manual-code" placeholder="è¼¸å…¥ç¥¨è™Ÿå¦‚ tcjhs113XXXXX" />
      <button onclick="manualEntry()">é€å‡º</button>

      <h2>ğŸ“Š å…¥å ´çµ±è¨ˆè³‡è¨Š</h2>
      <div class="stats">
        <div>ç¸½ç™¼è¡Œï¼š<span id="total-count"></span></div>
        <div>å·²å…¥å ´ï¼š<span id="entered-count">0</span></div>
        <div>æœªå…¥å ´ï¼š<span id="remaining-count">0</span></div>
      </div>

      <h2>ğŸ“‹ å…¥å ´åå–®</h2>
      <ul id="entry-list"></ul>

      <button onclick="downloadTXT()">ä¸‹è¼‰å…¥å ´ç´€éŒ„</button>
      <button onclick="resetEntries()">ğŸ”„ é‡ç½®å…¥å ´ç´€éŒ„</button>
    </div>
  </div>

  <script>
    const issuedTickets = `
tcjhs11372100
tcjhs11372101
tcjhs11372102
tcjhs11372103
tcjhs11372104
tcjhs11372105
tcjhs11372106
tcjhs11372107
tcjhs11372108
tcjhs11372109
tcjhs11372110
tcjhs11372111
tcjhs11372112
tcjhs11372113
tcjhs11372115
tcjhs11372116
tcjhs11372117
tcjhs11372118
tcjhs11372131
tcjhs11372132
tcjhs11372133
tcjhs11372134
tcjhs11372135
tcjhs11372137
tcjhs11372138
tcjhs11372139
tcjhs11372140
tcjhs11372141
tcjhs11372142
tcjhs11372143
tcjhs11372144
tcjhs11372145
tcjhs11372146`.trim().split('\n');

    const customMessages = {
      'tcjhs11372100': 'æ­¡è¿ ç”·ç¥è€å¸« å…¥å ´ï¼',
      'tcjhs11372102': 'æ­è¿ åŸ·è¡Œé•· ç‹é¡—ç¿” å…¥å ´ï¼',
      'tcjhs11372103': 'æœ‰è«‹ è£½ä½œäºº å°å³ å…¥å ´ï¼',
      'tcjhs11372112': 'æ­¡è¿ å‰å°ç¶“ç† ç´¹å‡ å…¥å ´ï¼',
      'tcjhs11372143': 'æ­¡è¿ ç¸½å°æ¼” æº«å®œèŠ³ å…¥å ´ï¼'
    };

    const enteredTickets = new Set();
    const result = document.getElementById('scan-result');
    const totalCount = document.getElementById('total-count');
    const enteredCount = document.getElementById('entered-count');
    const remainingCount = document.getElementById('remaining-count');
    const entryList = document.getElementById('entry-list');
    totalCount.textContent = issuedTickets.length;

    let audioEnabled = false;
    let isSpeaking = false; // æ¨™è¨˜æ˜¯å¦æ­£åœ¨æœ—è®€

    function updateStats() {
      enteredCount.textContent = enteredTickets.size;
      remainingCount.textContent = issuedTickets.length - enteredTickets.size;
    }

    function speak(text) {
      if (!audioEnabled) return;
      if (isSpeaking) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-TW';
      utterance.rate = 1;
      utterance.pitch = 1;
      utterance.onstart = function() {
        isSpeaking = true; // æ¨™è¨˜ç‚ºæ­£åœ¨æœ—è®€
      };
      utterance.onend = function() {
        isSpeaking = false; // æœ—è®€å®Œæˆï¼Œæ¨™è¨˜ç‚ºæœªæœ—è®€
      };
      speechSynthesis.speak(utterance);
    }

    function showTemporaryMessage(message, color = 'green') {
      result.textContent = message;
      result.style.color = color;

      // è¨­å®šè¨Šæ¯é¡¯ç¤ºæ™‚é–“ç‚ºäº”ç§’é˜ï¼Œä¸¦ç­‰å¾…äº”ç§’å¾Œæ¸…é™¤è¨Šæ¯
      setTimeout(() => {
        result.textContent = 'è«‹æƒæç¥¨åˆ¸æˆ–è¼¸å…¥ç¥¨è™Ÿ';
        result.style.color = 'black';
      }, 5000);
    }

    function handleCode(code) {
      if (isSpeaking) {
        result.textContent = "â³ è«‹ç­‰æœ—è®€å®Œæˆå¾Œå†æƒæ";
        result.style.color = 'red';
        return;
      }

      code = code.trim().toLowerCase();
      if (!issuedTickets.includes(code)) {
        result.textContent = `âŒ ç„¡æ•ˆç¥¨è™Ÿï¼š${code}`;
        result.style.color = 'red';
        return;
      }
      if (enteredTickets.has(code)) {
        result.textContent = `âš ï¸ å·²å…¥å ´éï¼š${code}`;
        result.style.color = 'orange';
        return;
      }

      enteredTickets.add(code);
      const time = new Date().toLocaleTimeString();
      const lastTwo = code.slice(-2);  // å–å¾—ç¥¨è™Ÿæœ€å¾Œå…©ç¢¼
      const customMsg = customMessages[code] || `æ­¡è¿ 721ç­ç¬¬${lastTwo}è™Ÿå…¥å ´ï¼`;
      showTemporaryMessage(`âœ… å…¥å ´æˆåŠŸï¼š${customMsg}`, 'green');
      speak(customMsg);
      updateStats();

      // åˆ—å‡ºå…¥å ´ç´€éŒ„
      const li = document.createElement('li');
      li.textContent = `${time} - ${customMsg}`;
      entryList.appendChild(li);
    }

    // æ‰‹å‹•è¼¸å…¥é€å‡º
    function manualEntry() {
      const input = document.getElementById('manual-code');
      if (!input.value.trim()) {
        alert('è«‹è¼¸å…¥ç¥¨è™Ÿ');
        return;
      }
      handleCode(input.value);
      input.value = '';
    }

    // ä¸‹è¼‰TXTæª”
    function downloadTXT() {
      if (enteredTickets.size === 0) {
        alert('å°šç„¡å…¥å ´ç´€éŒ„ï¼Œç„¡æ³•ä¸‹è¼‰');
        return;
      }
      let content = 'å…¥å ´æ™‚é–“,ç¥¨è™Ÿ,èªªæ˜\n';
      entryList.querySelectorAll('li').forEach(li => {
        // è§£ææ–‡å­—ï¼Œæ ¼å¼ï¼šHH:MM:SS - æ­¡è¿ xxx å…¥å ´ï¼
        const parts = li.textContent.split(' - ');
        content += `${parts[0]},${extractCodeFromMsg(parts[1])},${parts[1]}\n`;
      });
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `å…¥å ´ç´€éŒ„_${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // å¾è¨Šæ¯ä¸­åæ¨ç¥¨è™Ÿ
    function extractCodeFromMsg(msg) {
      for (let code of enteredTickets) {
        if (msg.includes(code) || msg.includes(code.slice(-2))) {
          return code;
        }
      }
      return '';
    }

    // é‡ç½®å…¥å ´ç´€éŒ„
    function resetEntries() {
      if (!confirm('ç¢ºå®šè¦é‡ç½®å…¥å ´ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
      enteredTickets.clear();
      entryList.innerHTML = '';
      updateStats();
      result.textContent = 'å…¥å ´ç´€éŒ„å·²é‡ç½®';
      result.style.color = 'blue';
    }

    // éŸ³è¨Šé–‹é—œ
    function toggleAudio() {
      audioEnabled = !audioEnabled;
      document.getElementById('start-audio').textContent = audioEnabled ? 'ğŸ”Š æœ—è®€å·²å•Ÿç”¨' : 'ğŸ”‡ æœ—è®€å·²ç¦ç”¨';
    }

    // QuaggaJS åˆå§‹åŒ–æ”å½±æ©Ÿæƒæ
    function startScanner() {
      const videoContainer = document.getElementById('video-container');
      Quagga.init({
        inputStream : {
          name : "Live",
          type : "LiveStream",
          target: videoContainer,
          constraints: {
            width: 640,
            height: 480,
            facingMode: "environment" // èƒŒé¢æ”å½±æ©Ÿ
          }
        },
        decoder : {
          readers : ["code_128_reader","ean_reader","ean_8_reader","code_39_reader","code_39_vin_reader","codabar_reader","upc_reader","upc_e_reader","i2of5_reader","2of5_reader","code_93_reader"]
        }
      }, function(err) {
          if (err) {
              console.log(err);
              result.textContent = 'âŒ æ”å½±æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™ä¸¦é‡æ–°æ•´ç†é é¢';
              result.style.color = 'red';
              return;
          }
          Quagga.start();
          result.textContent = 'è«‹æƒæç¥¨åˆ¸æˆ–è¼¸å…¥ç¥¨è™Ÿ';
          result.style.color = 'black';
      });

      Quagga.onDetected(data => {
        if(data && data.codeResult && data.codeResult.code) {
          handleCode(data.codeResult.code);
        }
      });
    }

    window.onload = () => {
      updateStats();
      startScanner();
    }
  </script>
</body>
</html>
